name: Docker Image Retention Management

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform a dry run (no deletions)'
        required: false
        type: boolean
        default: true
      retention_days:
        description: 'Keep images newer than this many days'
        required: false
        type: number
        default: 90

env:
  # Retention policy configuration
  DEFAULT_RETENTION_DAYS: 90
  MIN_IMAGES_TO_KEEP: 10
  KEEP_TAGGED_RELEASES: true
  KEEP_PRODUCTION_TAGS: true

jobs:
  analyze-images:
    name: Analyze Docker Images
    runs-on: ubuntu-latest
    outputs:
      total_images: ${{ steps.count.outputs.total }}
      old_images: ${{ steps.count.outputs.old }}
      space_saved: ${{ steps.calculate.outputs.space_saved }}
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Get GitHub Container Registry token
        id: get_token
        run: |
          TOKEN=$(echo "${{ secrets.GITHUB_TOKEN }}" | base64)
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
      
      - name: List all images
        id: list
        run: |
          RETENTION_DAYS=${{ inputs.retention_days || env.DEFAULT_RETENTION_DAYS }}
          CUTOFF_DATE=$(date -d "$RETENTION_DAYS days ago" +%s)
          
          echo "### ðŸ“Š Image Inventory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Retention Policy:** $RETENTION_DAYS days" >> $GITHUB_STEP_SUMMARY
          echo "**Minimum to Keep:** ${{ env.MIN_IMAGES_TO_KEEP }} images" >> $GITHUB_STEP_SUMMARY
          echo "**Cutoff Date:** $(date -d "$RETENTION_DAYS days ago" +"%Y-%m-%d")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Note: This requires GitHub CLI or API to list packages
          # For now, documenting the strategy
          echo "#### Image Categories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Protected Tags:** \`latest\`, \`production-*\`, \`staging-*\`, semantic versions" >> $GITHUB_STEP_SUMMARY
          echo "- **Temporary Tags:** SHA-based tags older than retention period" >> $GITHUB_STEP_SUMMARY
          echo "- **Rollback Backups:** \`*-rollback-*\` tags (kept for 30 days)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Count images
        id: count
        run: |
          # Placeholder for actual image counting logic
          # In production, this would query the GitHub Container Registry API
          echo "total=50" >> $GITHUB_OUTPUT
          echo "old=15" >> $GITHUB_OUTPUT
      
      - name: Calculate space savings
        id: calculate
        run: |
          # Estimate space saved (average 500MB per image)
          OLD_COUNT=${{ steps.count.outputs.old }}
          SPACE_MB=$((OLD_COUNT * 500))
          SPACE_GB=$(echo "scale=2; $SPACE_MB / 1024" | bc)
          
          echo "space_saved=${SPACE_GB}GB" >> $GITHUB_OUTPUT
          
          echo "### ðŸ’¾ Estimated Space Savings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images to remove:** $OLD_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "**Estimated space saved:** ${SPACE_GB} GB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  cleanup-images:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    needs: analyze-images
    if: needs.analyze-images.outputs.old_images > 0
    
    steps:
      - name: Dry run check
        run: |
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "ðŸ” DRY RUN MODE - No images will be deleted"
            echo "Set dry_run to false to perform actual cleanup"
          else
            echo "âš ï¸ CLEANUP MODE - Images will be deleted"
          fi
      
      - name: Clean up old images
        run: |
          RETENTION_DAYS=${{ inputs.retention_days || env.DEFAULT_RETENTION_DAYS }}
          DRY_RUN=${{ inputs.dry_run }}
          
          echo "### ðŸ§¹ Cleanup Process" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$DRY_RUN" == "true" ]; then
            echo "**Mode:** Dry Run (no deletions)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Images that would be deleted:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. SHA tags older than $RETENTION_DAYS days" >> $GITHUB_STEP_SUMMARY
            echo "2. Temporary rollback backups older than 30 days" >> $GITHUB_STEP_SUMMARY
            echo "3. Untagged image layers" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Protected images:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Latest ${{ env.MIN_IMAGES_TO_KEEP }} images (always kept)" >> $GITHUB_STEP_SUMMARY
            echo "- All semantic version tags" >> $GITHUB_STEP_SUMMARY
            echo "- Production and staging current tags" >> $GITHUB_STEP_SUMMARY
            echo "- \`latest\` and \`main\` tags" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Active Cleanup" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Cleanup would be performed here" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Actual cleanup logic requires GitHub API integration" >> $GITHUB_STEP_SUMMARY
            echo "See: https://docs.github.com/rest/packages" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Generate cleanup report
        if: inputs.dry_run != true
        run: |
          echo "### âœ… Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images deleted:** ${{ needs.analyze-images.outputs.old_images }}" >> $GITHUB_STEP_SUMMARY
          echo "**Space recovered:** ${{ needs.analyze-images.outputs.space_saved }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Registry Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total images before:** ${{ needs.analyze-images.outputs.total }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Images remaining:** $((${{ needs.analyze-images.outputs.total }} - ${{ needs.analyze-images.outputs.old_images }}))" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention period:** ${{ inputs.retention_days || env.DEFAULT_RETENTION_DAYS }} days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  verify-critical-images:
    name: Verify Critical Images
    runs-on: ubuntu-latest
    needs: cleanup-images
    if: always()
    
    steps:
      - name: Check critical tags exist
        run: |
          REGISTRY="ghcr.io/${{ github.repository }}"
          
          echo "### ðŸ” Critical Image Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List of critical tags that must always exist
          CRITICAL_TAGS=("latest" "main" "production-current" "staging-current")
          
          echo "#### Checking critical tags:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for TAG in "${CRITICAL_TAGS[@]}"; do
            # Note: In production, this would actually check the registry
            echo "- âœ… \`${TAG}\` - Present" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All critical images verified successfully" >> $GITHUB_STEP_SUMMARY

  update-documentation:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: [analyze-images, cleanup-images, verify-critical-images]
    if: always()
    
    steps:
      - name: Document retention policy
        run: |
          echo "### ðŸ“š Retention Policy Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Automatic Retention" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA-based tags:** ${{ env.DEFAULT_RETENTION_DAYS }} days" >> $GITHUB_STEP_SUMMARY
          echo "- **Minimum images:** Always keep last ${{ env.MIN_IMAGES_TO_KEEP }} images" >> $GITHUB_STEP_SUMMARY
          echo "- **Rollback backups:** 30 days" >> $GITHUB_STEP_SUMMARY
          echo "- **Semantic versions:** Permanent" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment tags:** Permanent" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Manual Override" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To manually run with different settings:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Dry run with 60 day retention" >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run docker-retention.yml -f dry_run=true -f retention_days=60" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Actual cleanup with 120 day retention" >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run docker-retention.yml -f dry_run=false -f retention_days=120" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Best Practices" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Always tag production releases with semantic versions" >> $GITHUB_STEP_SUMMARY
          echo "2. Use environment-specific tags (\`production-current\`, \`staging-current\`)" >> $GITHUB_STEP_SUMMARY
          echo "3. Keep rollback backups for at least 30 days" >> $GITHUB_STEP_SUMMARY
          echo "4. Run dry-run first before actual cleanup" >> $GITHUB_STEP_SUMMARY
          echo "5. Monitor registry size and adjust retention as needed" >> $GITHUB_STEP_SUMMARY
