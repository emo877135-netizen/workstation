# Automated Pull Request Pattern

## Overview

This repository uses a standardized pattern for all automated updates to ensure visibility, review, and controlled change management. Instead of pushing directly to the main branch, automated workflows create pull requests that can be reviewed and merged.

## Pattern Standard

### 1. Use PR Creation Action

All automated workflows MUST use the `peter-evans/create-pull-request@v7` action instead of direct `git push`:

```yaml
- name: Create Pull Request for automated update
  uses: peter-evans/create-pull-request@v7
  with:
    token: ${{ secrets.GITHUB_TOKEN }}
    branch: auto/{type}-update-${{ github.run_number }}
    base: main
    commit-message: |
      {emoji} {description} - {timestamp} [skip ci]
      
      - Detailed change list
      - Metadata
      
      Automated by {Agent/Workflow Name}
    title: "{emoji} {Short title} [skip ci]"
    body: |
      ## {emoji} Automated {Type} Update
      
      {Description of changes}
      
      ### Changes Included
      - ✅ {Change 1}
      - ✅ {Change 2}
      
      ### Metadata
      - **Trigger**: ${{ github.event_name }}
      - **Run ID**: ${{ github.run_id }}
      
      ---
      **Auto-generated by**: {Workflow name}
    delete-branch: true
    labels: |
      automated
      {specific-category}
      skip-ci
```

### 2. Required Permissions

Workflows must have the `pull-requests: write` permission:

```yaml
permissions:
  contents: write
  pull-requests: write
```

### 3. Branch Naming Convention

Branch names MUST follow the pattern: `auto/{type}-update-{run_number}`

Examples:
- `auto/metrics-update-123`
- `auto/agent-status-update-456`
- `auto/code-timeline-update-789`
- `auto/mcp-sync-1011`

### 4. Skip CI Flag

All automated commits MUST include `[skip ci]` to prevent infinite loops:

```yaml
title: "chore: auto-update metrics [skip ci]"
commit-message: "chore: auto-update metrics [skip ci]"
```

### 5. Labels

Every automated PR MUST include at least these labels:
- `automated` - Marks as automated
- `skip-ci` - Reinforces skip-ci flag
- Category-specific label (e.g., `metrics`, `documentation`, `mcp-sync`)

### 6. Delete Branch After Merge

Always set `delete-branch: true` to keep repository clean.

## Workflows Using This Pattern

### Metrics and Statistics
- **metrics-update.yml** - Repository metrics updates
  - Branch: `auto/metrics-update-{run_number}`
  - Labels: `automated`, `metrics`, `skip-ci`

- **code-timeline-agent.yml** - Code timeline tracking
  - Branch: `auto/code-timeline-update-{run_number}`
  - Labels: `automated`, `metrics`, `skip-ci`

### Documentation Updates
- **agent-status-cron.yml** - Agent status in documentation
  - Branch: `auto/agent-status-update-{run_number}`
  - Labels: `automated`, `documentation`, `skip-ci`

- **repo-update-agent.yml** - Repository documentation sync
  - Branch: `auto/repo-update-{run_number}`
  - Labels: `automated`, `documentation`, `metrics`, `skip-ci`

- **wikibrarian-agent.yml** - MCP memory updates
  - Branch: `auto/wikibrarian-memory-{run_number}`
  - Labels: `automated`, `wikibrarian`, `mcp-memory`, `skip-ci`

### Infrastructure Updates
- **mcp-branch-watch.yml** - MCP repository sync
  - Branch: `auto/mcp-sync-{run_number}`
  - Labels: `automated`, `mcp-sync`, `skip-ci`

- **rollback-validation.yml** - Rollback snapshots
  - Branch: `auto/rollback-snapshot-{run_number}`
  - Labels: `automated`, `rollback`, `infrastructure`, `skip-ci`

### Content Updates
- **edugit-codeagent.yml** - Educational curriculum
  - Branch: `auto/edugit-curriculum-update-{run_number}`
  - Labels: `automated`, `curriculum`, `education`, `skip-ci`

## Exceptions to the Pattern

Some workflows have specific scenarios where direct push is necessary:

### 1. Emergency Rollback Operations
**File**: `repo-update-agent.yml`
**Reason**: Rollback operations are emergency recovery actions that need immediate application without PR delay.
**Code Location**: Lines 354-379 (self-healing rollback), 381-407 (manual rollback)

### 2. Wiki Repository Updates
**File**: `wikibrarian-agent.yml`
**Reason**: GitHub Wiki is a separate repository that cannot use the main repo's PR workflow.
**Code Location**: Lines 490-518 (wiki push)

### 3. Cleanup Operations
**File**: `repo-update-agent.yml`
**Reason**: Minor maintenance cleanup of old rollback files.
**Code Location**: Lines 435-447 (cleanup old rollbacks)

All exceptions are documented with inline comments:
```yaml
# Direct push for emergency rollback (no PR needed for recovery)
git push
```

## Benefits of This Pattern

### 1. Visibility
- All automated changes are visible in PR list
- Clear history of what was changed and why
- Easy to track automation activity

### 2. Review Capability
- Changes can be reviewed before merge
- Catch unexpected automation behavior
- Validate metrics and data updates

### 3. Rollback Support
- Easy to revert by closing PR
- Clear commit history
- Branch-based isolation

### 4. Consistency
- Uniform approach across all automations
- Predictable branch names
- Standard labels and metadata

### 5. Integration
- Works with GitHub Actions and webhooks
- Compatible with branch protection rules
- Supports auto-merge workflows

## Migration Checklist

When converting a workflow to use this pattern:

- [ ] Add `pull-requests: write` permission
- [ ] Replace `git push` with `peter-evans/create-pull-request@v7`
- [ ] Use `auto/{type}-update-{run_number}` branch naming
- [ ] Include `[skip ci]` in title and commit message
- [ ] Add `automated` and `skip-ci` labels
- [ ] Set `delete-branch: true`
- [ ] Provide detailed PR body with:
  - [ ] Changes summary
  - [ ] Metadata (trigger, run ID, etc.)
  - [ ] Source workflow reference
- [ ] Test workflow syntax
- [ ] Verify permissions are sufficient
- [ ] Document any exceptions with inline comments

## Testing

### Workflow Syntax Validation
```bash
# Install actionlint
brew install actionlint

# Validate workflow files
actionlint .github/workflows/*.yml
```

### Manual Trigger Test
1. Go to Actions tab in GitHub
2. Select the workflow
3. Click "Run workflow"
4. Check that PR is created (not direct push)
5. Verify PR has correct labels
6. Confirm branch follows naming pattern

## Troubleshooting

### "Resource not accessible by integration" Error
**Problem**: Missing `pull-requests: write` permission
**Solution**: Add to workflow permissions:
```yaml
permissions:
  contents: write
  pull-requests: write
```

### PR Not Created
**Problem**: No changes to commit
**Solution**: This is normal - PR action detects no changes and exits gracefully

### Branch Already Exists
**Problem**: Using static branch name instead of `{run_number}`
**Solution**: Update branch name to include `${{ github.run_number }}`

### Infinite Loop
**Problem**: Missing `[skip ci]` flag
**Solution**: Add `[skip ci]` to both title and commit message

## Version History

- **v2.0.0** (2025-12-10): Standardized all automated workflows to use PR pattern
- **v1.0.0** (Initial): Mixed approach with some direct pushes

## Related Documentation

- [GitHub Actions Workflow Syntax](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions)
- [peter-evans/create-pull-request](https://github.com/peter-evans/create-pull-request)
- [GitHub Permissions](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token)

## Support

For questions or issues with this pattern:
1. Check existing workflow files for examples
2. Review this documentation
3. Check workflow run logs in Actions tab
4. Create an issue with `automation` label
